<div class="container my-4" style="max-width:820px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-1">Conversation with <%= @partner.respond_to?(:full_name) ? (@partner.full_name.presence || @partner.name || @partner.email) : (@partner.name || @partner.email) %></h4>
    </div>
    <%= link_to "Back to Messages", messages_path, class: "btn btn-sm btn-outline-secondary" %>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body" data-messages-container style="max-height: 50vh; overflow-y: auto;">
      <% @messages.each do |m| %>
        <div class="mb-3">
          <div class="<%= m.sender_id == current_user.id ? 'text-end' : 'text-start' %>">
            <div class="d-inline-block px-3 py-2 rounded <%= m.sender_id == current_user.id ? 'bg-primary text-white' : 'bg-light' %>">
              <%= simple_format h(m.body) %>
            </div>
          </div>
          <div class="small text-muted <%= m.sender_id == current_user.id ? 'text-end' : '' %>">
            <%= m.created_at.in_time_zone.strftime("%b %-d, %Y %l:%M %p") %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <%= form_with model: @message,
                    url: messages_path,
                    local: true do |f| %>
        <%= f.hidden_field :recipient_id %>

        <!-- Add this label so the Cucumber step can find "Message" -->
        <div class="mb-2">
          <%= f.label :body, "Message", class: "form-label" %>
          <%= f.text_area :body,
                          class: "form-control",
                          rows: 3,
                          placeholder: "Write a reply... (Press Enter to send, Shift+Enter for newline)" %>
        </div>

        <div class="text-end">
          <%= f.submit "Send", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  const setupMessagePage = () => {
    const container = document.querySelector("[data-messages-container]");
    if (container) {
      container.scrollTop = container.scrollHeight;
    }

    const textarea = document.getElementById("message_body");
    if (textarea && !textarea.dataset.enterBound) {
      textarea.dataset.enterBound = "true";
      textarea.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          const form = textarea.closest("form");
          if (form) form.submit();
        }
      });
    }
  };

  document.addEventListener("DOMContentLoaded", setupMessagePage);
  document.addEventListener("turbo:load", setupMessagePage);
</script>
